@model CreateSceneModel

<form asp-action="CreateScene" method="post" enctype="multipart/form-data">
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
    <input type="hidden" asp-for="Scenes.id_part" value="@Model.partId" />
    <input type="hidden" asp-for="partId" value="@Model.partId" />
    <h3>Додати нову сцену</h3>

    <div class="form-group mb-3">
        <label class="form-label">Тип сцени:</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" asp-for="Scenes.answer" id="textSceneRadio" value="false" checked="@(!Model.Scenes.answer)" onchange="toggleSceneType(false)" />
            <label class="form-check-label" for="textSceneRadio">Текстова сцена</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" asp-for="Scenes.answer" id="answerSceneRadio" value="true" checked="@(Model.Scenes.answer)" onchange="toggleSceneType(true)" />
            <label class="form-check-label" for="answerSceneRadio">Сцена з варіантами вибору</label>
        </div>
    </div>

    <div id="textSceneSection" style="display: @(Model.Scenes.answer ? "none" : "block")">
        <div class="form-group">
            <label>Текст сцени</label>
            <textarea asp-for="Scenes.text_scene" class="form-control" rows="5"></textarea>
        </div>
    </div>

    <div id="answerSceneSection" style="display: @(Model.Scenes.answer ? "block" : "none")">
        <h4>Варіанти відповідей</h4>
        <div id="answersContainer">
            @if (Model.Scenes.answer && Model.Answers != null)
            {
                for (int i = 0; i < Model.Answers.Count; i++)
                {
                    <div class="mb-2 p-2 border rounded">
                        <input type="text" name="Answers[@i].asnwer_for_scene"
                               value="@Model.Answers[i].asnwer_for_scene"
                               class="form-control mb-1"
                               placeholder="Варіант @(i + 1)" required />
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentNode.remove()">
                            Видалити
                        </button>
                    </div>
                }
            }
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addAnswerField()">
            + Додати варіант
        </button>
    </div>

    <!-- Інші поля форми -->
    <div class="form-group mb-3">
        <h3>Яка сцена є попередньою для цієї?</h3>
        <select name="preview_scene" class="form-control">
            <option value="-1">(Початок історії, немає попередньої сцени)</option>
            @if (Model.AllItems?.Scene != null)
            {
                foreach (var scene in Model.AllItems.Scene)
                {
                    <option value="@scene.id" selected="@(scene.id == Model.preview_scene)">
                        @{
                            var partName = Model.AllItems.Parts?.FirstOrDefault(p => p.id == scene.id_part)?.name ?? "Невідомий парт";
                        }
                        Парт "@partName" - @(scene.text_scene.Length > 50 ? scene.text_scene.Substring(0, 50) + "..." : scene.text_scene)
                    </option>
                }
            }
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label">Фонове зображення:</label>
        <input type="file" asp-for="@Model.backgroundImage" class="form-control" />
    </div>

    <button type="submit" class="btn btn-success mt-3">Зберегти сцену</button>
</form>

@section Scripts {
    <script>
        let answerCounter = @(Model.Answers?.Count ?? 0);

        // Ініціалізація при завантаженні сторінки
        document.addEventListener('DOMContentLoaded', function() {
            // Якщо це сцена з варіантами, додамо перше поле, якщо воно відсутнє
            if (@Model.Scenes.answer.ToString().ToLower() && answerCounter === 0) {
                addAnswerField();
            }
        });

        function toggleSceneType(isAnswer) {
            const textSection = document.getElementById('textSceneSection');
            const answerSection = document.getElementById('answerSceneSection');

            textSection.style.display = isAnswer ? 'none' : 'block';
            answerSection.style.display = isAnswer ? 'block' : 'none';

            // Якщо переключили на сцену з варіантами і немає жодного поля - додаємо
            if (isAnswer && answerCounter === 0) {
                addAnswerField();
            }
        }

        function addAnswerField() {
            const container = document.getElementById('answersContainer');
            const wrapper = document.createElement('div');
            wrapper.className = 'mb-2 p-2 border rounded';

            const input = document.createElement('input');
            input.type = 'text';
            input.name = `Answers[${answerCounter}].asnwer_for_scene`;
            input.placeholder = `Варіант ${answerCounter + 1}`;
            input.className = 'form-control mb-1';
            input.required = true;

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-sm btn-outline-danger';
            deleteBtn.textContent = 'Видалити';
            deleteBtn.onclick = function() {
                container.removeChild(wrapper);
                answerCounter--;
                // Оновлюємо індекси для всіх полів
                updateAnswerIndexes();
            };

            wrapper.appendChild(input);
            wrapper.appendChild(deleteBtn);
            container.appendChild(wrapper);

            answerCounter++;
        }

        function updateAnswerIndexes() {
            const containers = document.querySelectorAll('#answersContainer > div');
            containers.forEach((container, index) => {
                const input = container.querySelector('input');
                input.name = `Answers[${index}].asnwer_for_scene`;
                input.placeholder = `Варіант ${index + 1}`;
            });
        }
    </script>
}