@using NovelProject.AlterModels
@model DetailSceneModel
<style>
    .image-option {
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
    }

        .image-option input:checked + img {
            border: 2px solid #007bff;
        }

    .selectable-image {
        width: 100px;
        height: auto;
        border-radius: 8px;
        transition: transform 0.2s;
    }

        .selectable-image:hover {
            transform: scale(1.05);
        }
</style>

<form asp-action="DetailScene" method="post" enctype="multipart/form-data">
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    <!-- Ідентифікатор сцени -->
    <input type="hidden" asp-for="Scenes.id" />

    <h3>Оновити сцену</h3>

    <div class="form-group mb-3">
        <label class="form-label">Тип сцени:</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" asp-for="Scenes.answer" id="textSceneRadio" value="false" checked="@(!Model.Scenes.answer)" onchange="toggleSceneType(false)" />
            <label class="form-check-label" for="textSceneRadio">Текстова сцена</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" asp-for="Scenes.answer" id="answerSceneRadio" value="true" checked="@(Model.Scenes.answer)" onchange="toggleSceneType(true)" />
            <label class="form-check-label" for="answerSceneRadio">Сцена з варіантами вибору</label>
        </div>
    </div>

    <div id="textSceneSection" style="display: @(Model.Scenes.answer ? "none" : "block")">
        <div class="form-group">
            <label>Текст сцени</label>
            <textarea asp-for="Scenes.text_scene" class="form-control" rows="5"></textarea>
        </div>
    </div>

    <div id="answerSceneSection" style="display: @(Model.Scenes.answer ? "block" : "none")">
        <h4>Варіанти відповідей</h4>
        <div id="answersContainer">
            @if (Model.Scenes.answer && Model.Answers != null)
            {
                for (int i = 0; i < Model.Answers.Count; i++)
                {
                    <div class="mb-2 p-2 border rounded">
                        <input type="text" name="Answers[@i].asnwer_for_scene"
                               value="@Model.Answers[i].asnwer_for_scene"
                               class="form-control mb-1"
                               placeholder="Варіант @(i + 1)" required />
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentNode.remove()">
                            Видалити
                        </button>
                    </div>
                }
            }
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addAnswerField()">
            + Додати варіант
        </button>
    </div>

    <div class="form-group mb-3">
        <h3>Які сцени (або відповіді) є попередніми для цієї?</h3>

        <label class="form-label">Сцени</label>
        <select name="preview_scene_ids[]" class="form-control" multiple size="5">
            @if (Model.preview_scene_ids != null)
            {
                bool isSelectedStartScene = Model.preview_scene_ids.Contains(-1);
                <option value="-1" selected="@(isSelectedStartScene)">
                    (Початок історії, немає попередньої сцени)
                </option>
            }

            @if (Model.AllItems?.Scene != null)
            {
                foreach (var scene in Model.AllItems.Scene)
                {
                    bool isSelected = Model.preview_scene_ids.Contains(scene.id);
                    var partName = Model.AllItems.Parts?.FirstOrDefault(p => p.id == scene.id_part)?.name ?? "Невідомий парт";
                    var shortText = Model?.AllItems?.Scene != null && scene.text_scene != null 
                    ? (scene.text_scene.Length > 50 ? scene.text_scene.Substring(0, 50) + "..." : scene.text_scene)
                    : "No text available";
                    <option value="@scene.id" selected="@(isSelected)">
                        Парт "@partName" - @shortText
                    </option>
                }
            }
        </select>

        <label class="form-label mt-3">Відповіді</label>
        <select name="preview_answer_ids[]" class="form-control" multiple size="3">
            @if (Model.preview_answer_ids != null)
            {
                bool isSelectedStartAnswer = Model.preview_answer_ids.Contains(-1);
                <option value="-1" selected="@(isSelectedStartAnswer)">
                    (Початок історії, немає попередньої відповіді)
                </option>
            }

            @if (Model.AllItems?.Answers != null)
            {
                foreach (var answer in Model.AllItems.Answers)
                {
                    bool isSelected = Model.preview_answer_ids.Contains(answer.id);
                    var shortAnswer = answer.asnwer_for_scene.Length > 50
                    ? answer.asnwer_for_scene.Substring(0, 50) + "..."
                    : answer.asnwer_for_scene;

                    <option value="@answer.id" selected="@(isSelected)">
                        Відповідь: @shortAnswer
                    </option>
                }
            }

        </select>

    </div>

    <h4 class="mt-4">Оберіть зображення</h4>
    <div class="d-flex gap-4 overflow-auto mb-4">
        <!-- Backgrounds -->
        <div>
            <p class="fw-bold">Фон</p>
            <div class="d-flex flex-row gap-2 flex-wrap image-selector">
                @foreach (var file in Model.BackgroundImagePaths)
                {
                    <label class="image-option">
                        <input type="radio" asp-for="Scenes.background_scene_img" value="@file"
                               checked="@(Model.Scenes.background_scene_img == file)" />
                        <img src="@file" alt="background" class="selectable-image" />
                    </label>
                }
            </div>
        </div>

        <!-- Personages -->
        <div>
            <p class="fw-bold">Персонаж</p>
            <div class="d-flex flex-row gap-2 flex-wrap image-selector">
                @foreach (var file in Model.PersonageImagePaths)
                {
                    <label class="image-option">
                        <input type="radio" asp-for="Scenes.personage_scene_img" value="@file"
                               checked="@(Model.Scenes.personage_scene_img == file)" />
                        <img src="@file" alt="personage" class="selectable-image" />
                    </label>
                }
            </div>
        </div>

        <!-- Additional -->
        <div>
            <p class="fw-bold">Додаткове</p>
            <div class="d-flex flex-row gap-2 flex-wrap image-selector">
                @foreach (var file in Model.AdditionalImagePaths)
                {
                    <label class="image-option">
                        <input type="radio" asp-for="Scenes.additional_scene_img" value="@file"
                               checked="@(Model.Scenes.additional_scene_img == file)" />
                        <img src="@file" alt="additional" class="selectable-image" />
                    </label>
                }
            </div>
        </div>
    </div>


    <button type="submit" class="btn btn-primary mt-3">Оновити сцену</button>

</form>
<form asp-action="DeleteScene" method="post">
    <input type="hidden" name="id" value="@Model.Scenes.id" />
    <button type="submit" class="btn btn-danger mt-3">Видалити сцену</button>
</form>
@section Scripts {
    <script>

        let answerIndex = @Model.Answers?.Count ?? 0;

        function addAnswerField() {
            const container = document.getElementById("answersContainer");

            const div = document.createElement("div");
            div.className = "mb-2 p-2 border rounded";

            div.innerHTML = `
                <input type="text" name="Answers[${answerIndex}].asnwer_for_scene"
                       class="form-control mb-1"
                       placeholder="Варіант ${answerIndex + 1}" required />
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentNode.remove(); updateAnswerIndexes();">
                    Видалити
                </button>
            `;

            container.appendChild(div);
            answerIndex++;
        }

        function updateAnswerIndexes() {
            const container = document.getElementById("answersContainer");
            const children = container.children;
            answerIndex = 0;

            for (let i = 0; i < children.length; i++) {
                const input = children[i].querySelector('input[type="text"]');
                input.name = `Answers[${i}].asnwer_for_scene`;
                input.placeholder = `Варіант ${i + 1}`;
                answerIndex = i + 1;
            }
        }
    </script>
}